name: Deploy React + PocketBase

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
    
    - name: Install React dependencies
      run: npm ci
    
    - name: Build React app
      run: npm run build
    
    # Создаем простой сервер для React + PocketBase
    - name: Create combined server
      run: |
        mkdir -p combined
        cp -r build/* combined/
        echo '{
          "name": "combined-server",
          "version": "1.0.0",
          "main": "server.js",
          "scripts": {
            "start": "node server.js"
          },
          "dependencies": {
            "express": "^4.18.2",
            "cors": "^2.8.5"
          }
        }' > combined/package.json
        
        echo '
        const express = require("express");
        const cors = require("cors");
        const { exec } = require("child_process");
        const path = require("path");
        
        const app = express();
        app.use(cors());
        
        // Статика React
        app.use(express.static(path.join(__dirname)));
        
        // Запускаем PocketBase как дочерний процесс
        const pocketbase = exec("./pocketbase serve --http=0.0.0.0:8090", {
          cwd: path.join(__dirname, "../pocketbase")
        });
        
        pocketbase.stdout.on("data", (data) => {
          console.log(\`PocketBase: \${data}\`);
        });
        
        pocketbase.stderr.on("data", (data) => {
          console.error(\`PocketBase error: \${data}\`);
        });
        
        // Прокси для PocketBase API
        const { createProxyMiddleware } = require("http-proxy-middleware");
        app.use(
          "/api",
          createProxyMiddleware({
            target: "http://localhost:8090",
            changeOrigin: true,
            pathRewrite: {
              "^/api": "/api"
            }
          })
        );
        
        // Все остальные запросы → React
        app.get("*", (req, res) => {
          res.sendFile(path.join(__dirname, "index.html"));
        });
        
        const PORT = process.env.PORT || 3000;
        app.listen(PORT, () => {
          console.log(\`Server running on port \${PORT}\`);
        });
        ' > combined/server.js

    - name: Deploy to GitHub Pages
      uses: JamesIves/github-pages-deploy-action@v4
      with:
        folder: combined
        branch: gh-pages